# cargo-deny configuration for Ito workspace
#
# Enforces license compliance and dependency advisories using standard
# Rust ecosystem tooling, reducing reliance on bespoke scripts.
#
# Install: cargo install cargo-deny
# Run:     cargo deny --manifest-path ito-rs/Cargo.toml check
#
# Migration note (015-13): Dependency *direction* enforcement (onion
# architecture layers) stays in arch_guardrails.py because cargo-deny
# cannot enforce intra-workspace crate edges. This config covers
# license and advisory checks that cargo-deny handles natively.

[graph]
targets = []
all-features = true
no-default-features = false

# ──────────────────────────────────────────────────────────────────────
# Advisories: deny known-vulnerable or unmaintained crates
# ──────────────────────────────────────────────────────────────────────
[advisories]
# v2: all advisory types (vulnerability, unmaintained, unsound, notice)
# default to deny. No per-type overrides needed.
version = 2
ignore = []

# ──────────────────────────────────────────────────────────────────────
# Licenses: allow only OSS-compatible licenses
# ──────────────────────────────────────────────────────────────────────
[licenses]
# v2: unlisted licenses are denied by default. copyleft, allow-osi-fsf-free,
# default, and unlicensed fields are removed.
version = 2
allow = [
    "MIT",
    "Apache-2.0",
    "BSD-2-Clause",
    "BSD-3-Clause",
    "ISC",
    "Unicode-3.0",
    "Zlib",
    "BSL-1.0",
]
confidence-threshold = 0.8

# ──────────────────────────────────────────────────────────────────────
# Bans: general dependency hygiene
# ──────────────────────────────────────────────────────────────────────
[bans]
multiple-versions = "deny"
wildcards = "allow"
highlight = "all"

# Transitive duplicates we cannot resolve — upstream crates pin different
# major versions. Revisit when upgrading crossterm, rusqlite, miette, or
# portable-pty.
skip = [
    # portable-pty pins bitflags 1.x; everything else uses 2.x
    { crate = "bitflags@1", reason = "portable-pty transitive" },
    # rusqlite→hashlink pins hashbrown 0.14; serde_yaml→indexmap uses 0.16
    { crate = "hashbrown@0.14", reason = "rusqlite transitive" },
    # crossterm/gethostname use rustix 0.38; tempfile/terminal_size use 1.x
    { crate = "rustix@0.38", reason = "crossterm/gethostname transitive" },
    { crate = "linux-raw-sys@0.4", reason = "follows rustix 0.38" },
    # portable-pty→filedescriptor pins thiserror 1.x
    { crate = "thiserror@1", reason = "portable-pty transitive" },
    { crate = "thiserror-impl@1", reason = "follows thiserror 1.x" },
    # miette uses unicode-width 0.1; console/indicatif/textwrap use 0.2
    { crate = "unicode-width@0.1", reason = "miette transitive" },
    # windows-sys ecosystem: crossterm/console/insta pin 0.59, tokio/clap
    # pin 0.60, mio/console pin 0.61 — cascades to windows-targets and
    # per-arch link crates
    { crate = "windows-sys@0.59", reason = "crossterm/insta transitive" },
    { crate = "windows-sys@0.60", reason = "tokio/clap transitive" },
    { crate = "windows-targets@0.52", reason = "follows windows-sys 0.59" },
    { crate = "windows_aarch64_gnullvm@0.52", reason = "follows windows-targets 0.52" },
    { crate = "windows_aarch64_msvc@0.52", reason = "follows windows-targets 0.52" },
    { crate = "windows_i686_gnu@0.52", reason = "follows windows-targets 0.52" },
    { crate = "windows_i686_gnullvm@0.52", reason = "follows windows-targets 0.52" },
    { crate = "windows_i686_msvc@0.52", reason = "follows windows-targets 0.52" },
    { crate = "windows_x86_64_gnu@0.52", reason = "follows windows-targets 0.52" },
    { crate = "windows_x86_64_gnullvm@0.52", reason = "follows windows-targets 0.52" },
    { crate = "windows_x86_64_msvc@0.52", reason = "follows windows-targets 0.52" },
]

# ──────────────────────────────────────────────────────────────────────
# Sources: restrict to crates.io
# ──────────────────────────────────────────────────────────────────────
[sources]
unknown-registry = "deny"
unknown-git = "deny"
allow-registry = ["https://github.com/rust-lang/crates.io-index"]
allow-git = []
